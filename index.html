<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <title>My Favorite Albums - Heart Collage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 html2canvas 用于截图保存 -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        :root {
            --collage-max-width: 600px;
            --bg-color: #ffffff;
            --bg-image: none;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #1a1a1a;
            user-select: none;
            transition: background 0.3s ease;
            margin: 0;
        }

        /* ---------------- Toast 提示条 ---------------- */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(30, 30, 30, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }
        
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.loading { background-color: #3b82f6; }

        /* ---------------- 截图区域 & 拼图容器 ---------------- */
        
        /* 截图区域：包含标题和拼图 */
        #captureArea {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* 留出上下边距，保证生成的图片好看 */
            padding-top: 40px;
            padding-bottom: 40px;
            transition: background 0.3s ease;
        }

        .collage-container {
            width: 100%;
            max-width: var(--collage-max-width);
            display: flex;
            justify-content: center;
            transition: max-width 0.3s ease;
        }

        .collage-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 6px;
            width: 100%;
            aspect-ratio: 7/6; 
        }

        .album-box {
            background-color: rgba(243, 244, 246, 0.8);
            border: 2px solid #1a1a1a;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.1s, border-color 0.2s, background-color 0.3s;
            backdrop-filter: blur(5px);
        }

        .album-box:hover {
            border-color: #000;
            z-index: 10;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background-color: rgba(243, 244, 246, 1);
        }

        .album-box:active { transform: scale(0.98); }

        .album-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .album-box.has-image .album-img { opacity: 1; }

        /* 空状态 UI */
        .album-box::before, .album-box::after {
            content: '';
            position: absolute;
            background: #d1d5db;
            transition: background 0.2s;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .album-box::before { width: 2px; height: 20px; }
        .album-box::after { width: 20px; height: 2px; }
        .album-box:hover::before, .album-box:hover::after { background: #9ca3af; }
        .album-box.has-image::before, .album-box.has-image::after { display: none; }
        .album-box.loading::before, .album-box.loading::after { display: none; }

        /* Loading Spinner */
        .spinner {
            display: none;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 20px; height: 20px;
            border: 2px solid #e5e7eb;
            border-top-color: #1a1a1a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .album-box.loading .spinner { display: block; }

        /* 网格位置定义 */
        .pos-1  { grid-column: 2; grid-row: 1; }
        .pos-2  { grid-column: 3; grid-row: 1; }
        .pos-3  { grid-column: 5 / span 2; grid-row: 1 / span 2; } /* BIG */
        .pos-4  { grid-column: 1; grid-row: 2; }
        .pos-5  { grid-column: 2 / span 2; grid-row: 2 / span 2; } /* BIG */
        .pos-6  { grid-column: 4; grid-row: 2; }
        .pos-7  { grid-column: 7; grid-row: 2; }
        .pos-8  { grid-column: 1; grid-row: 3; }
        .pos-9  { grid-column: 4; grid-row: 3; }
        .pos-10 { grid-column: 5 / span 2; grid-row: 3 / span 2; } /* BIG */
        .pos-11 { grid-column: 7; grid-row: 3; }
        .pos-12 { grid-column: 2; grid-row: 4; }
        .pos-13 { grid-column: 3 / span 2; grid-row: 4 / span 2; } /* BIG */
        .pos-14 { grid-column: 5; grid-row: 5; }
        .pos-15 { grid-column: 4; grid-row: 6; }

        /* Modal 弹窗 */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: white;
            width: 90%; max-width: 420px;
            border-radius: 16px;
            padding: 24px;
            transform: scale(0.95);
            transition: transform 0.2s;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .modal-overlay.active .modal-content { transform: scale(1); }

        /* Controls */
        .controls-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s, transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.active {
            border-color: #1a1a1a;
            transform: scale(1.1);
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
        }
        
        /* 上传按钮样式 */
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .upload-btn {
            border: 2px solid #e5e7eb;
            color: #6b7280;
            background-color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-btn:hover {
            border-color: #1a1a1a;
            color: #1a1a1a;
        }

        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        
        /* 保存按钮样式 */
        .save-btn {
            background-color: #1a1a1a;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        .save-btn:hover {
            background-color: #333;
        }
        
        .save-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- 关键修改：Capture Area 包含了标题和拼图 -->
    <div id="captureArea">
        <!-- 标题 -->
        <h1 class="text-3xl md:text-4xl mb-6 text-center text-gray-900 tracking-tight" style="text-shadow: 0 1px 2px rgba(255,255,255,0.5);">
            my <span class="font-bold">favorite</span> albums
        </h1>

        <!-- 拼图容器 -->
        <div class="collage-container" id="collageContainer">
            <div class="collage-grid" id="gridContainer">
                <!-- Grid generated by JS -->
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div class="mt-4 text-center px-4 space-y-4 w-full max-w-xs pb-10">
        <div class="text-sm text-gray-600" style="text-shadow: 0 1px 1px rgba(255,255,255,0.5);">
            <p>点击方块添加专辑</p>
            <div class="text-xs text-gray-400 mt-1">
                支持 <span class="font-bold text-red-600">网易云链接</span> 或 直接粘贴图片链接
            </div>
        </div>

        <!-- Controls Section -->
        <div class="controls-container space-y-3">
            <!-- Size Slider -->
            <div class="flex items-center justify-between text-xs text-gray-600">
                <label for="sizeSlider">调整大小</label>
                <input type="range" id="sizeSlider" min="300" max="1000" step="10" value="600" class="w-32 accent-black">
            </div>

            <!-- Background Controls -->
            <div class="flex items-center justify-between text-xs text-gray-600">
                <span>背景设置</span>
                <div class="flex gap-2 items-center" id="bgControls">
                    <div class="color-option active" data-bg-color="#ffffff" data-bg-image="none" style="background-color: #ffffff;" title="白色"></div>
                    <div class="color-option" data-bg-color="#f3f4f6" data-bg-image="none" style="background-color: #f3f4f6;" title="浅灰"></div>
                    <div class="color-option" data-bg-color="#fef3c7" data-bg-image="none" style="background-color: #fef3c7;" title="米色"></div>
                    <div class="color-option" data-bg-color="transparent" data-bg-image="linear-gradient(to right, #ffecd2 0%, #fcb69f 100%)" style="background-image: linear-gradient(to right, #ffecd2 0%, #fcb69f 100%);" title="渐变"></div>
                    
                    <!-- 本地上传按钮 -->
                    <div class="upload-btn-wrapper" title="上传本地图片">
                        <button class="upload-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                        </button>
                        <input type="file" id="bgUpload" accept="image/*">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex justify-between items-center pt-2">
            <button onclick="clearAll()" class="text-xs text-gray-400 underline hover:text-red-500" style="text-shadow: 0 1px 1px rgba(255,255,255,0.5);">
                清空所有
            </button>
            
            <button id="saveBtn" class="save-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                保存图片
            </button>
        </div>
    </div>

    <!-- Input Modal -->
    <div class="modal-overlay" id="inputModal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-1">设置专辑封面</h3>
            <p class="text-xs text-gray-500 mb-4">粘贴网易云专辑链接 (如: https://music.163.com/...) 或直接粘贴图片地址。</p>
            
            <div class="relative">
                <input type="text" id="urlInput" 
                       placeholder="粘贴链接..." 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black transition-all text-sm"
                       autocomplete="off">
            </div>

            <div class="flex justify-end gap-3 mt-5">
                <button onclick="closeModal()" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    取消
                </button>
                <button onclick="handleInput()" class="px-6 py-2 text-sm bg-black text-white rounded-lg hover:bg-gray-800 transition-colors shadow-lg">
                    确定
                </button>
            </div>
        </div>
    </div>

    <script>
        const gridStructure = [
            { id: 1, class: 'pos-1' }, { id: 2, class: 'pos-2' }, { id: 3, class: 'pos-3' },
            { id: 4, class: 'pos-4' }, { id: 5, class: 'pos-5' }, { id: 6, class: 'pos-6' },
            { id: 7, class: 'pos-7' }, { id: 8, class: 'pos-8' }, { id: 9, class: 'pos-9' },
            { id: 10, class: 'pos-10' }, { id: 11, class: 'pos-11' }, { id: 12, class: 'pos-12' },
            { id: 13, class: 'pos-13' }, { id: 14, class: 'pos-14' }, { id: 15, class: 'pos-15' }
        ];

        let currentBoxId = null;
        const storageKey = 'heart_collage_v7_fullsave'; 
        let appData = {
            albums: {},
            settings: {
                size: 600,
                bgColor: '#ffffff',
                bgImage: 'none',
                isCustomBg: false 
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderGrid();
            initControls();
        });

        function renderGrid() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            gridStructure.forEach(item => {
                const div = document.createElement('div');
                div.className = `album-box ${item.class}`;
                div.id = `box-${item.id}`;
                div.onclick = () => openModal(item.id);
                // 重要：添加 crossorigin="anonymous"
                div.innerHTML = `<div class="spinner"></div><img class="album-img" alt="" crossorigin="anonymous">`;
                container.appendChild(div);
            });
            for (const [id, url] of Object.entries(appData.albums)) {
                updateBoxUI(id, url);
            }
        }

        function loadData() {
            try {
                const data = localStorage.getItem(storageKey);
                if (data) {
                    appData = JSON.parse(data);
                    if (!appData.settings) {
                        appData.settings = { size: 600, bgColor: '#ffffff', bgImage: 'none', isCustomBg: false };
                    }
                }
            } catch(e) {
                console.error("Load failed", e);
                appData = { albums: {}, settings: { size: 600, bgColor: '#ffffff', bgImage: 'none', isCustomBg: false } };
            }
            applySettings();
        }

        function saveData() {
            try {
                localStorage.setItem(storageKey, JSON.stringify(appData));
            } catch (e) {
                console.error("Storage error", e);
                showToast('数据过大，背景图可能未保存', 'error');
            }
        }

        function applySettings() {
            // Apply Size
            document.documentElement.style.setProperty('--collage-max-width', `${appData.settings.size}px`);
            const sizeSlider = document.getElementById('sizeSlider');
            if (sizeSlider) sizeSlider.value = appData.settings.size;

            // Apply Background
            document.documentElement.style.setProperty('--bg-color', appData.settings.bgColor);
            document.documentElement.style.setProperty('--bg-image', appData.settings.bgImage);
            updateActiveColorOption();
        }

        function initControls() {
            // Size Slider
            const sizeSlider = document.getElementById('sizeSlider');
            sizeSlider.addEventListener('input', (e) => {
                const newSize = e.target.value;
                appData.settings.size = newSize;
                document.documentElement.style.setProperty('--collage-max-width', `${newSize}px`);
                saveData();
            });

            // Background Controls
            const bgControls = document.getElementById('bgControls');
            bgControls.addEventListener('click', (e) => {
                const option = e.target.closest('.color-option');
                if (!option) return;

                const bgColor = option.dataset.bgColor;
                const bgImage = option.dataset.bgImage;

                appData.settings.bgColor = bgColor;
                appData.settings.bgImage = bgImage;
                appData.settings.isCustomBg = false;
                
                applySettings();
                saveData();
            });

            // Background Upload
            const bgUpload = document.getElementById('bgUpload');
            bgUpload.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    if (this.files[0].size > 3 * 1024 * 1024) {
                        showToast('图片太大，请选择 <3MB 的图片', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const bgImageUrl = `url(${e.target.result})`;
                        appData.settings.bgColor = 'transparent';
                        appData.settings.bgImage = bgImageUrl;
                        appData.settings.isCustomBg = true;
                        applySettings();
                        saveData();
                        bgUpload.value = ''; 
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            // Save Image Button
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.addEventListener('click', saveCollageAsImage);
        }

        function updateActiveColorOption() {
            const options = document.querySelectorAll('.color-option');
            options.forEach(opt => opt.classList.remove('active'));
            
            if (appData.settings.isCustomBg) return; 

            const activeOption = Array.from(options).find(opt => 
                opt.dataset.bgColor === appData.settings.bgColor && 
                opt.dataset.bgImage === appData.settings.bgImage
            );
            if (activeOption) activeOption.classList.add('active');
        }
        
        // --- Save Image Logic ---
        function saveCollageAsImage() {
            // 现在的目标是包含标题的父容器
            const captureElement = document.getElementById('captureArea');
            const body = document.body;
            
            showToast('正在生成图片...', 'loading');
            
            // 记录原始样式，以便截图后恢复
            const originalBgColor = captureElement.style.backgroundColor;
            const originalBgImage = captureElement.style.backgroundImage;
            const originalBgSize = captureElement.style.backgroundSize;
            const originalBgPos = captureElement.style.backgroundPosition;
            
            // 核心步骤：将 Body 的背景临时应用到截图区域上
            // 这样截图时就能包含你设置的背景（无论是颜色还是图片）
            captureElement.style.backgroundColor = getComputedStyle(body).backgroundColor;
            captureElement.style.backgroundImage = getComputedStyle(body).backgroundImage;
            captureElement.style.backgroundSize = 'cover';
            captureElement.style.backgroundPosition = 'center';

            html2canvas(captureElement, {
                useCORS: true, 
                scale: 2, // 提高清晰度
                backgroundColor: null, // 透明背景，完全依赖元素自身的背景
                allowTaint: true
            }).then(canvas => {
                // 恢复元素的原始样式
                captureElement.style.backgroundColor = originalBgColor;
                captureElement.style.backgroundImage = originalBgImage;
                captureElement.style.backgroundSize = originalBgSize;
                captureElement.style.backgroundPosition = originalBgPos;
                
                // 触发下载
                const link = document.createElement('a');
                link.download = 'my-heart-collage.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast('保存成功！', 'success');
            }).catch(err => {
                console.error('Save failed:', err);
                // 恢复样式
                captureElement.style.backgroundColor = originalBgColor;
                captureElement.style.backgroundImage = originalBgImage;
                captureElement.style.backgroundSize = originalBgSize;
                captureElement.style.backgroundPosition = originalBgPos;
                showToast('生成失败，可能是图片跨域限制', 'error');
            });
        }


        function updateBoxUI(id, url) {
            const box = document.getElementById(`box-${id}`);
            if (!box) return;
            const img = box.querySelector('img');
            box.classList.remove('loading');
            
            if (url) {
                const tempImg = new Image();
                tempImg.crossOrigin = "anonymous";
                tempImg.onload = () => {
                    img.src = url;
                    box.classList.add('has-image');
                };
                tempImg.onerror = () => {
                    box.classList.remove('has-image');
                };
                tempImg.src = url;
            } else {
                img.src = '';
                box.classList.remove('has-image');
            }
        }

        function clearAll() {
            if(confirm('确定清空所有数据？')) {
                localStorage.removeItem(storageKey);
                location.reload();
            }
        }

        // --- Toast System ---
        let toastTimer;
        function showToast(msg, type = 'default') {
            const toast = document.getElementById('toast');
            const icon = type === 'success' ? '✅' : (type === 'error' ? '❌' : '⏳');
            toast.textContent = `${icon} ${msg}`;
            toast.className = `toast ${type} show`;
            
            if (toastTimer) clearTimeout(toastTimer);
            if (type !== 'loading') {
                toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
            }
        }

        // --- Input Handling ---
        const modal = document.getElementById('inputModal');
        const input = document.getElementById('urlInput');

        function openModal(id) {
            currentBoxId = id;
            input.value = '';
            modal.classList.add('active');
            setTimeout(() => input.focus(), 100);
        }
        function closeModal() {
            modal.classList.remove('active');
        }
        input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') handleInput();
        });

        async function handleInput() {
            const val = input.value.trim();
            if (!val) return closeModal();
            
            closeModal();
            const box = document.getElementById(`box-${currentBoxId}`);
            box.classList.add('loading');
            showToast('正在解析...', 'loading');

            let finalUrl = null;

            try {
                if (val.match(/\.(jpeg|jpg|gif|png|webp)($|\?)/i)) {
                    finalUrl = val;
                }
                else if (val.includes('music.163.com')) {
                    finalUrl = await fetchNeteaseCover(val);
                }
                else {
                    finalUrl = val; 
                }

                if (finalUrl) {
                    appData.albums[currentBoxId] = finalUrl;
                    updateBoxUI(currentBoxId, finalUrl);
                    saveData();
                    showToast('获取成功', 'success');
                } else {
                    box.classList.remove('loading');
                    showToast('链接无效', 'error');
                }

            } catch (err) {
                console.error(err);
                box.classList.remove('loading');
                showToast('网络请求失败', 'error');
            }
        }

        // --- Core: Fetch Logic ---
        async function fetchNeteaseCover(inputUrl) {
            const idMatch = inputUrl.match(/(?:[?&]id=|\/album\/)(\d+)/);
            if (!idMatch) return null;
            const id = idMatch[1];
            const targetApi = `http://music.163.com/api/album/${id}`;
            const timestamp = Date.now(); 

            const proxies = [
                {
                    url: (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&t=${timestamp}`,
                    type: 'json-wrap'
                },
                {
                    url: (url) => `https://thingproxy.freeboard.io/fetch/${url}`,
                    type: 'direct'
                },
                {
                    url: (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}&t=${timestamp}`,
                    type: 'direct'
                }
            ];

            for (const proxy of proxies) {
                try {
                    const proxyUrl = proxy.url(targetApi);
                    const res = await fetch(proxyUrl, { 
                        method: 'GET',
                        signal: AbortSignal.timeout(5000) 
                    });
                    if (!res.ok) continue;

                    let data = await res.json();
                    if (proxy.type === 'json-wrap' && data.contents) {
                        try { data = JSON.parse(data.contents); } catch(e) { continue; } 
                    }

                    if (data && data.album && data.album.picUrl) {
                        let pic = data.album.picUrl;
                        if(pic.startsWith('http://')) pic = pic.replace('http://', 'https://');
                        return pic + '?param=500y500';
                    }
                } catch (e) { continue; }
            }
            return null;
        }
    </script>
</body>
</html>
