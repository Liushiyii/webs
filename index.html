<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 核心修复1：彻底禁止发送 Referrer，防止网易云图片服务器返回 403 Forbidden -->
    <meta name="referrer" content="no-referrer">
    <!-- 核心修复2：强制将页面内的 HTTP 资源请求升级为 HTTPS，解决 GitHub Pages 的混合内容报错 -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <title>My Favorite Albums - Heart Collage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
            user-select: none;
        }

        /* ---------------- Toast 提示条 ---------------- */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(30, 30, 30, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }
        
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.loading { background-color: #3b82f6; }

        /* ---------------- 拼图网格布局 ---------------- */
        .collage-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .collage-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 6px;
            width: 100%;
            aspect-ratio: 7/6; 
        }

        .album-box {
            background-color: #f3f4f6;
            border: 2px solid #1a1a1a;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.1s, border-color 0.2s;
        }

        .album-box:hover {
            border-color: #000;
            z-index: 10;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .album-box:active { transform: scale(0.98); }

        .album-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .album-box.has-image .album-img { opacity: 1; }

        /* 空状态 UI */
        .album-box::before, .album-box::after {
            content: '';
            position: absolute;
            background: #d1d5db;
            transition: background 0.2s;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .album-box::before { width: 2px; height: 20px; }
        .album-box::after { width: 20px; height: 2px; }
        .album-box:hover::before, .album-box:hover::after { background: #9ca3af; }
        .album-box.has-image::before, .album-box.has-image::after { display: none; }
        .album-box.loading::before, .album-box.loading::after { display: none; }

        /* Loading Spinner */
        .spinner {
            display: none;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 20px; height: 20px;
            border: 2px solid #e5e7eb;
            border-top-color: #1a1a1a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .album-box.loading .spinner { display: block; }

        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

        /* 网格位置定义 */
        .pos-1  { grid-column: 2; grid-row: 1; }
        .pos-2  { grid-column: 3; grid-row: 1; }
        .pos-3  { grid-column: 5 / span 2; grid-row: 1 / span 2; } /* BIG */
        .pos-4  { grid-column: 1; grid-row: 2; }
        .pos-5  { grid-column: 2 / span 2; grid-row: 2 / span 2; } /* BIG */
        .pos-6  { grid-column: 4; grid-row: 2; }
        .pos-7  { grid-column: 7; grid-row: 2; }
        .pos-8  { grid-column: 1; grid-row: 3; }
        .pos-9  { grid-column: 4; grid-row: 3; }
        .pos-10 { grid-column: 5 / span 2; grid-row: 3 / span 2; } /* BIG */
        .pos-11 { grid-column: 7; grid-row: 3; }
        .pos-12 { grid-column: 2; grid-row: 4; }
        .pos-13 { grid-column: 3 / span 2; grid-row: 4 / span 2; } /* BIG */
        .pos-14 { grid-column: 5; grid-row: 5; }
        .pos-15 { grid-column: 4; grid-row: 6; }

        /* Modal 弹窗 */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: white;
            width: 90%; max-width: 420px;
            border-radius: 16px;
            padding: 24px;
            transform: scale(0.95);
            transition: transform 0.2s;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8">

    <h1 class="text-3xl md:text-4xl mb-6 text-center text-gray-900 tracking-tight">
        my <span class="font-bold">favorite</span> albums
    </h1>

    <div id="toast" class="toast"></div>

    <div class="collage-container">
        <div class="collage-grid" id="gridContainer">
            <!-- Grid generated by JS -->
        </div>
    </div>

    <div class="mt-8 text-center px-4 space-y-2">
        <p class="text-sm text-gray-600">点击方块添加专辑</p>
        <div class="text-xs text-gray-400">
            支持 <span class="font-bold text-red-600">网易云链接</span> (网页/分享) 或 <span class="font-bold text-blue-600">直接搜专辑名</span>
        </div>
        <button onclick="clearAll()" class="mt-4 text-xs text-gray-400 underline hover:text-red-500">
            清空所有
        </button>
    </div>

    <!-- Input Modal -->
    <div class="modal-overlay" id="inputModal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-1">设置专辑封面</h3>
            <p class="text-xs text-gray-500 mb-4">输入网易云链接，或者直接输入 "歌手 专辑名" 进行搜索。</p>
            
            <div class="relative">
                <input type="text" id="urlInput" 
                       placeholder="例如: 蛋堡 月光" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black transition-all text-sm"
                       autocomplete="off">
            </div>

            <div class="flex justify-end gap-3 mt-5">
                <button onclick="closeModal()" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    取消
                </button>
                <button onclick="handleInput()" class="px-6 py-2 text-sm bg-black text-white rounded-lg hover:bg-gray-800 transition-colors shadow-lg">
                    确定
                </button>
            </div>
        </div>
    </div>

    <script>
        const gridStructure = [
            { id: 1, class: 'pos-1' }, { id: 2, class: 'pos-2' }, { id: 3, class: 'pos-3' },
            { id: 4, class: 'pos-4' }, { id: 5, class: 'pos-5' }, { id: 6, class: 'pos-6' },
            { id: 7, class: 'pos-7' }, { id: 8, class: 'pos-8' }, { id: 9, class: 'pos-9' },
            { id: 10, class: 'pos-10' }, { id: 11, class: 'pos-11' }, { id: 12, class: 'pos-12' },
            { id: 13, class: 'pos-13' }, { id: 14, class: 'pos-14' }, { id: 15, class: 'pos-15' }
        ];

        let currentBoxId = null;
        const storageKey = 'heart_collage_v3';

        document.addEventListener('DOMContentLoaded', () => {
            renderGrid();
            loadData();
        });

        function renderGrid() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            gridStructure.forEach(item => {
                const div = document.createElement('div');
                div.className = `album-box ${item.class}`;
                div.id = `box-${item.id}`;
                div.onclick = () => openModal(item.id);
                div.innerHTML = `<div class="spinner"></div><img class="album-img" alt="">`;
                container.appendChild(div);
            });
        }

        function loadData() {
            try {
                const data = JSON.parse(localStorage.getItem(storageKey) || '{}');
                for (const [id, url] of Object.entries(data)) {
                    updateBoxUI(id, url);
                }
            } catch(e) {}
        }

        function saveData(id, url) {
            const data = JSON.parse(localStorage.getItem(storageKey) || '{}');
            data[id] = url;
            localStorage.setItem(storageKey, JSON.stringify(data));
        }

        function updateBoxUI(id, url) {
            const box = document.getElementById(`box-${id}`);
            const img = box.querySelector('img');
            box.classList.remove('loading');
            
            if (url) {
                const tempImg = new Image();
                tempImg.onload = () => {
                    img.src = url;
                    box.classList.add('has-image');
                };
                tempImg.onerror = () => {
                    box.classList.remove('has-image');
                };
                tempImg.src = url;
            } else {
                img.src = '';
                box.classList.remove('has-image');
            }
        }

        function clearAll() {
            if(confirm('确定清空？')) {
                localStorage.removeItem(storageKey);
                location.reload();
            }
        }

        // --- Toast System ---
        let toastTimer;
        function showToast(msg, type = 'default') {
            const toast = document.getElementById('toast');
            const icon = type === 'success' ? '✅' : (type === 'error' ? '❌' : '⏳');
            toast.textContent = `${icon} ${msg}`;
            toast.className = `toast ${type} show`;
            
            if (toastTimer) clearTimeout(toastTimer);
            if (type !== 'loading') {
                toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
            }
        }

        // --- Input Handling ---
        const modal = document.getElementById('inputModal');
        const input = document.getElementById('urlInput');

        function openModal(id) {
            currentBoxId = id;
            input.value = '';
            modal.classList.add('active');
            setTimeout(() => input.focus(), 100);
        }
        function closeModal() {
            modal.classList.remove('active');
        }
        input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') handleInput();
        });

        async function handleInput() {
            const val = input.value.trim();
            if (!val) return closeModal();
            
            closeModal();
            const box = document.getElementById(`box-${currentBoxId}`);
            box.classList.add('loading');
            showToast('正在解析...', 'loading');

            let finalUrl = null;

            try {
                // 1. 是图片链接?
                if (val.match(/\.(jpeg|jpg|gif|png|webp)($|\?)/i)) {
                    finalUrl = val;
                }
                // 2. 是网易云链接? (包含 music.163.com)
                else if (val.includes('music.163.com')) {
                    finalUrl = await fetchNeteaseCover(val);
                }
                // 3. 都不像? 尝试作为关键词搜索
                else if (!val.startsWith('http')) {
                    finalUrl = await searchAppleMusic(val);
                }
                // 4. 其他链接
                else {
                    finalUrl = val; 
                }

                if (finalUrl) {
                    updateBoxUI(currentBoxId, finalUrl);
                    saveData(currentBoxId, finalUrl);
                    showToast('获取成功', 'success');
                } else {
                    box.classList.remove('loading');
                    showToast('解析失败，建议直接搜 "专辑名"', 'error');
                }

            } catch (err) {
                console.error(err);
                box.classList.remove('loading');
                showToast('网络请求失败', 'error');
            }
        }

        // --- Core: 增强版网易云抓取 (适配 GitHub Pages) ---
        async function fetchNeteaseCover(inputUrl) {
            // 正则匹配: 兼容 ?id=xxx 和 /album/xxx 两种格式
            const idMatch = inputUrl.match(/(?:[?&]id=|\/album\/)(\d+)/);
            if (!idMatch) return null;
            const id = idMatch[1];
            const targetApi = `http://music.163.com/api/album/${id}`;
            const timestamp = Date.now(); // 关键: 防止代理缓存

            // 定义代理列表 (优先使用 corsproxy.io, 它是专门为跨域设计的)
            const proxies = [
                // 线路 1: corsproxy.io (通常最稳)
                (url) => `https://corsproxy.io/?url=${encodeURIComponent(url)}&t=${timestamp}`,
                // 线路 2: allorigins (备用)
                (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&t=${timestamp}`,
                // 线路 3: codetabs (备备用)
                (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}&t=${timestamp}`
            ];

            for (const createProxyUrl of proxies) {
                try {
                    const proxyUrl = createProxyUrl(targetApi);
                    console.log('Trying proxy:', proxyUrl);
                    
                    const res = await fetch(proxyUrl, { 
                        method: 'GET',
                        signal: AbortSignal.timeout(6000) 
                    });
                    
                    if (!res.ok) continue;

                    const data = await res.json();
                    
                    // 处理不同代理的返回结构
                    let json = data;
                    if (data.contents) {
                        try {
                            json = JSON.parse(data.contents);
                        } catch(e) { json = data.contents; } // 可能是纯对象
                    }

                    if (json && json.album && json.album.picUrl) {
                        // 强制 HTTPS 并获取中等尺寸图片
                        let pic = json.album.picUrl;
                        if(pic.startsWith('http://')) pic = pic.replace('http://', 'https://');
                        return pic + '?param=500y500';
                    }
                } catch (e) {
                    console.warn('Proxy error:', e);
                    continue;
                }
            }
            // 所有的代理都失败了? 尝试降级为搜专辑名 (如果能提取的话)
            return null;
        }

        // --- Core: Apple Music 搜索 (无需代理，HTTPS友好) ---
        async function searchAppleMusic(keyword) {
            const apiUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(keyword)}&entity=album&limit=1&country=CN`;
            try {
                const res = await fetch(apiUrl);
                const data = await res.json();
                if (data.resultCount > 0) {
                    // 获取高清图
                    return data.results[0].artworkUrl100.replace('100x100bb', '600x600bb');
                }
            } catch (e) {
                console.error("iTunes search failed", e);
            }
            return null;
        }

    </script>
</body>
</html>
