<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 关键修复：解决网易云图片 403 Forbidden 防盗链问题 -->
    <meta name="referrer" content="no-referrer">
    <!-- 关键修复：升级不安全请求，尽量强制 HTTPS -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <title>My Favorite Albums - Heart Collage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
            user-select: none; /* 防止长按选中文本影响体验 */
        }

        /* Toast 提示框 */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(30, 30, 30, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }
        
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.loading { background-color: #3b82f6; }

        /* 拼图网格 */
        .collage-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .collage-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 6px;
            width: 100%;
            aspect-ratio: 7/6; /* 保持比例 */
        }

        .album-box {
            background-color: #f3f4f6;
            border: 2px solid #1a1a1a;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.1s, border-color 0.2s;
        }

        .album-box:hover {
            border-color: #000;
            z-index: 10;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .album-box:active { transform: scale(0.98); }

        .album-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .album-box.has-image .album-img { opacity: 1; }

        /* 加号图标 */
        .album-box::before, .album-box::after {
            content: '';
            position: absolute;
            background: #d1d5db;
            transition: background 0.2s;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* 竖线 */
        .album-box::before { width: 2px; height: 20px; }
        /* 横线 */
        .album-box::after { width: 20px; height: 2px; }

        .album-box:hover::before, .album-box:hover::after { background: #9ca3af; }
        
        .album-box.has-image::before, .album-box.has-image::after { display: none; }
        .album-box.loading::before, .album-box.loading::after { display: none; }

        /* 加载动画 */
        .spinner {
            display: none;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 20px; height: 20px;
            border: 2px solid #e5e7eb;
            border-top-color: #1a1a1a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .album-box.loading .spinner { display: block; }

        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

        /* 布局位置 */
        .pos-1  { grid-column: 2; grid-row: 1; }
        .pos-2  { grid-column: 3; grid-row: 1; }
        .pos-3  { grid-column: 5 / span 2; grid-row: 1 / span 2; } /* BIG */
        .pos-4  { grid-column: 1; grid-row: 2; }
        .pos-5  { grid-column: 2 / span 2; grid-row: 2 / span 2; } /* BIG */
        .pos-6  { grid-column: 4; grid-row: 2; }
        .pos-7  { grid-column: 7; grid-row: 2; }
        .pos-8  { grid-column: 1; grid-row: 3; }
        .pos-9  { grid-column: 4; grid-row: 3; }
        .pos-10 { grid-column: 5 / span 2; grid-row: 3 / span 2; } /* BIG */
        .pos-11 { grid-column: 7; grid-row: 3; }
        .pos-12 { grid-column: 2; grid-row: 4; }
        .pos-13 { grid-column: 3 / span 2; grid-row: 4 / span 2; } /* BIG */
        .pos-14 { grid-column: 5; grid-row: 5; }
        .pos-15 { grid-column: 4; grid-row: 6; }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: white;
            width: 90%; max-width: 420px;
            border-radius: 16px;
            padding: 24px;
            transform: scale(0.95);
            transition: transform 0.2s;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8">

    <h1 class="text-3xl md:text-4xl mb-6 text-center text-gray-900 tracking-tight">
        my <span class="font-bold">favorite</span> albums
    </h1>

    <div id="toast" class="toast"></div>

    <div class="collage-container">
        <div class="collage-grid" id="gridContainer">
            <!-- Grid Items Generated by JS -->
        </div>
    </div>

    <div class="mt-8 text-center px-4 space-y-2">
        <p class="text-sm text-gray-600">点击方块添加专辑</p>
        <div class="text-xs text-gray-400">
            支持 <span class="font-bold text-red-600">网易云链接</span> 或 <span class="font-bold text-blue-600">专辑名称搜索</span>
        </div>
        <button onclick="clearAll()" class="mt-4 text-xs text-gray-400 underline hover:text-red-500">
            清空画布
        </button>
    </div>

    <!-- Input Modal -->
    <div class="modal-overlay" id="inputModal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-1">设置专辑封面</h3>
            <p class="text-xs text-gray-500 mb-4">如果是网易云链接无法识别，请尝试直接输入专辑名称。</p>
            
            <div class="relative">
                <input type="text" id="urlInput" 
                       placeholder="粘贴链接 或 输入专辑名 (如: 周杰伦)" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-black transition-all text-sm"
                       autocomplete="off">
            </div>

            <div class="flex justify-end gap-3 mt-5">
                <button onclick="closeModal()" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    取消
                </button>
                <button onclick="handleInput()" class="px-6 py-2 text-sm bg-black text-white rounded-lg hover:bg-gray-800 transition-colors shadow-lg">
                    确定
                </button>
            </div>
        </div>
    </div>

    <script>
        const gridStructure = [
            { id: 1, class: 'pos-1' }, { id: 2, class: 'pos-2' }, { id: 3, class: 'pos-3' },
            { id: 4, class: 'pos-4' }, { id: 5, class: 'pos-5' }, { id: 6, class: 'pos-6' },
            { id: 7, class: 'pos-7' }, { id: 8, class: 'pos-8' }, { id: 9, class: 'pos-9' },
            { id: 10, class: 'pos-10' }, { id: 11, class: 'pos-11' }, { id: 12, class: 'pos-12' },
            { id: 13, class: 'pos-13' }, { id: 14, class: 'pos-14' }, { id: 15, class: 'pos-15' }
        ];

        let currentBoxId = null;
        const storageKey = 'heart_collage_v2'; // New key for fresh start

        document.addEventListener('DOMContentLoaded', () => {
            renderGrid();
            loadData();
        });

        function renderGrid() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            gridStructure.forEach(item => {
                const div = document.createElement('div');
                div.className = `album-box ${item.class}`;
                div.id = `box-${item.id}`;
                div.onclick = () => openModal(item.id);
                div.innerHTML = `<div class="spinner"></div><img class="album-img" alt="">`;
                container.appendChild(div);
            });
        }

        // --- Data Logic ---
        function loadData() {
            try {
                const data = JSON.parse(localStorage.getItem(storageKey) || '{}');
                for (const [id, url] of Object.entries(data)) {
                    updateBoxUI(id, url);
                }
            } catch(e) { console.error("Load failed", e); }
        }

        function saveData(id, url) {
            const data = JSON.parse(localStorage.getItem(storageKey) || '{}');
            data[id] = url;
            localStorage.setItem(storageKey, JSON.stringify(data));
        }

        function updateBoxUI(id, url) {
            const box = document.getElementById(`box-${id}`);
            const img = box.querySelector('img');
            
            // 重置状态
            box.classList.remove('loading');
            
            if (url) {
                // 预加载图片
                const tempImg = new Image();
                tempImg.onload = () => {
                    img.src = url;
                    box.classList.add('has-image');
                };
                tempImg.onerror = () => {
                    // 如果缓存的链接失效，默默移除
                    box.classList.remove('has-image');
                };
                tempImg.src = url;
            } else {
                img.src = '';
                box.classList.remove('has-image');
            }
        }

        function clearAll() {
            if(confirm('确定清空？')) {
                localStorage.removeItem(storageKey);
                location.reload();
            }
        }

        // --- Toast ---
        let toastTimer;
        function showToast(msg, type = 'default') {
            const toast = document.getElementById('toast');
            const icon = type === 'success' ? '✅' : (type === 'error' ? '❌' : '⏳');
            toast.textContent = `${icon} ${msg}`;
            toast.className = `toast ${type} show`;
            
            if (toastTimer) clearTimeout(toastTimer);
            if (type !== 'loading') {
                toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
            }
        }
        function hideToast() {
            document.getElementById('toast').classList.remove('show');
        }

        // --- Modal ---
        const modal = document.getElementById('inputModal');
        const input = document.getElementById('urlInput');

        function openModal(id) {
            currentBoxId = id;
            input.value = '';
            modal.classList.add('active');
            setTimeout(() => input.focus(), 100);
        }
        function closeModal() {
            modal.classList.remove('active');
        }
        
        input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') handleInput();
        });

        // --- Core Logic ---
        async function handleInput() {
            const val = input.value.trim();
            if (!val) return closeModal();
            
            closeModal();
            const box = document.getElementById(`box-${currentBoxId}`);
            box.classList.add('loading');
            showToast('正在寻找专辑...', 'loading');

            let finalUrl = null;

            try {
                // 策略 1: 是否是图片链接?
                if (val.match(/\.(jpeg|jpg|gif|png|webp)($|\?)/i)) {
                    finalUrl = val;
                }
                // 策略 2: 网易云链接?
                else if (val.includes('music.163.com')) {
                    finalUrl = await fetchNeteaseCover(val);
                }
                // 策略 3: 不是链接? 尝试作为关键词搜索 (Apple Music API)
                else if (!val.startsWith('http')) {
                    finalUrl = await searchAppleMusic(val);
                }
                // 策略 4: 其他链接，盲试
                else {
                    finalUrl = val; 
                }

                if (finalUrl) {
                    updateBoxUI(currentBoxId, finalUrl);
                    saveData(currentBoxId, finalUrl);
                    showToast('获取成功', 'success');
                } else {
                    box.classList.remove('loading');
                    showToast('未找到封面，请尝试输入专辑名', 'error');
                }

            } catch (err) {
                console.error(err);
                box.classList.remove('loading');
                showToast('网络错误，请重试', 'error');
            }
        }

        // 核心：网易云获取 (双线路 + 修正 HTTP)
        async function fetchNeteaseCover(inputUrl) {
            const idMatch = inputUrl.match(/[?&]id=(\d+)/);
            if (!idMatch) return null;
            const id = idMatch[1];
            const targetApi = `http://music.163.com/api/album/${id}`;

            // 定义代理列表 (CORS Proxy)
            // 注意：allorigins 在国内可能慢，codetabs 有时更稳
            const proxies = [
                (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
            ];

            for (const createProxyUrl of proxies) {
                try {
                    const proxyUrl = createProxyUrl(targetApi);
                    console.log('Trying proxy:', proxyUrl);
                    
                    const res = await fetch(proxyUrl, { 
                        method: 'GET',
                        signal: AbortSignal.timeout(5000) // 5秒超时
                    });
                    
                    if (!res.ok) continue;

                    const data = await res.json();
                    // 处理不同代理返回格式
                    const content = data.contents || data; 
                    const json = (typeof content === 'string') ? JSON.parse(content) : content;

                    if (json && json.album && json.album.picUrl) {
                        return json.album.picUrl.replace('http://', 'https://') + '?param=500y500';
                    }
                } catch (e) {
                    console.warn('Proxy failed:', e);
                    continue; // 试下一个
                }
            }
            return null;
        }

        // 备选核心：Apple Music 搜索 (国内直连稳定)
        async function searchAppleMusic(keyword) {
            // 使用 iTunes Search API, 专门搜专辑, 限制 1 条, 地区 CN
            const apiUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(keyword)}&entity=album&limit=1&country=CN`;
            
            // iTunes API 支持 CORS (通常)
            // 但为了保险，还是可以用 jsonp 或者 fetch
            // 现代浏览器 fetch 跨域 iTunes 有时会报错，但在 Script 标签里不会
            // 我们先尝试 fetch, iTunes 实际上支持 CORS
            try {
                const res = await fetch(apiUrl);
                const data = await res.json();
                if (data.resultCount > 0) {
                    // 获取高清图 (默认是100x100，替换文件名获得大图)
                    const smallUrl = data.results[0].artworkUrl100;
                    return smallUrl.replace('100x100bb', '600x600bb');
                }
            } catch (e) {
                // 如果 fetch 跨域失败，这是个备用的 JSONP 模拟方案（简化版：建议用户用英文搜）
                console.error("iTunes search failed", e);
            }
            return null;
        }

    </script>
</body>
</html>