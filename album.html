<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Favorite Albums - Heart Collage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #1a1a1a;
        }

        /* Toast 提示框样式 */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background-color: #10b981; /* Green */
        }
        
        .toast.error {
            background-color: #ef4444; /* Red */
        }

        /* 网格容器定义 */
        .collage-grid {
            display: grid;
            /* 7列，每列宽约 80px (在移动端自适应) */
            grid-template-columns: repeat(7, 80px);
            /* 6行 */
            grid-template-rows: repeat(6, 80px);
            gap: 10px;
            justify-content: center;
            padding: 20px;
            margin: 0 auto;
            max-width: 100%;
            overflow-x: auto;
        }

        /* 方块基础样式 */
        .album-box {
            background-color: #fff;
            border: 2px solid #1a1a1a;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .album-box:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #000;
        }

        .album-box:active {
            transform: scale(0.98);
        }

        /* 图片显示样式 */
        .album-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none; /* 默认隐藏，有src时显示 */
        }
        
        .album-box.has-image .album-img {
            display: block;
        }
        
        .album-box.has-image::after {
            content: ''; /* 移除加号 */
        }

        /* 空状态下的加号 */
        .album-box:not(.has-image)::after {
            content: '+';
            font-size: 24px;
            color: #e5e5e5;
            font-weight: bold;
        }
        
        .album-box:not(.has-image):hover::after {
            color: #999;
        }

        /* 正在加载状态 */
        .album-box.loading::after {
            content: '...';
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* 网格定位 (CSS Grid 1-based index) */
        
        /* Row 1 */
        .pos-1  { grid-column: 2; grid-row: 1; } /* Small */
        .pos-2  { grid-column: 3; grid-row: 1; } /* Small */
        .pos-3  { grid-column: 5 / span 2; grid-row: 1 / span 2; } /* BIG */

        /* Row 2 */
        .pos-4  { grid-column: 1; grid-row: 2; } /* Small */
        .pos-5  { grid-column: 2 / span 2; grid-row: 2 / span 2; } /* BIG */
        .pos-6  { grid-column: 4; grid-row: 2; } /* Small */
        .pos-7  { grid-column: 7; grid-row: 2; } /* Small */

        /* Row 3 */
        .pos-8  { grid-column: 1; grid-row: 3; } /* Small */
        .pos-9  { grid-column: 4; grid-row: 3; } /* Small */
        .pos-10 { grid-column: 5 / span 2; grid-row: 3 / span 2; } /* BIG */
        .pos-11 { grid-column: 7; grid-row: 3; } /* Small */

        /* Row 4 */
        .pos-12 { grid-column: 2; grid-row: 4; } /* Small */
        .pos-13 { grid-column: 3 / span 2; grid-row: 4 / span 2; } /* BIG */
        
        /* Row 5 */
        .pos-14 { grid-column: 5; grid-row: 5; } /* Small (Corrected position based on visual) */
        
        /* Row 6 */
        .pos-15 { grid-column: 4; grid-row: 6; } /* Small Bottom Tip */


        /* 响应式调整 */
        @media (max-width: 640px) {
            .collage-grid {
                grid-template-columns: repeat(7, 1fr);
                grid-template-rows: repeat(6, 1fr);
                gap: 4px;
                width: 100vw;
                height: 85vw; /* Maintain aspect ratio roughly */
                padding: 10px;
            }
            
            .title {
                font-size: 1.5rem !important;
                margin-bottom: 1rem !important;
            }
        }

        /* Modal 样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 50;
        }
        
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: translateY(20px);
            transition: transform 0.2s;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10">

    <!-- 标题 -->
    <h1 class="title text-4xl mb-8 text-center text-gray-800">
        my <span class="font-bold">favorite</span> albums
    </h1>

    <!-- 状态提示框 (Toast) -->
    <div id="toast" class="toast"></div>

    <!-- 拼图区域 -->
    <div class="collage-grid" id="gridContainer">
        <!-- JS 将在这里生成方块 -->
    </div>

    <div class="mt-8 text-gray-500 text-sm text-center px-4">
        <p>点击方框添加专辑</p>
        <p class="mt-1">支持直接粘贴 <span class="font-bold text-red-500">网易云音乐</span> 专辑链接自动抓取封面</p>
        <button onclick="clearAll()" class="mt-4 text-xs underline hover:text-red-600">清空所有</button>
    </div>

    <!-- 输入弹窗 -->
    <div class="modal-overlay" id="inputModal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">添加专辑</h3>
            <p class="text-sm text-gray-600 mb-4">粘贴网易云音乐专辑链接，或直接粘贴图片地址。</p>
            
            <input type="text" id="urlInput" placeholder="例如: https://music.163.com/..." 
                   class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-black transition-colors">
            
            <div class="flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">取消</button>
                <button onclick="confirmUrl()" class="px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800">确定</button>
            </div>
            
            <div id="errorMsg" class="text-red-500 text-xs mt-2 hidden">无法识别链接，请重试</div>
        </div>
    </div>

    <script>
        // 定义网格结构: id 与 CSS类名的映射
        const gridStructure = [
            { id: 1, class: 'pos-1' },
            { id: 2, class: 'pos-2' },
            { id: 3, class: 'pos-3' }, // Big
            { id: 4, class: 'pos-4' },
            { id: 5, class: 'pos-5' }, // Big
            { id: 6, class: 'pos-6' },
            { id: 7, class: 'pos-7' },
            { id: 8, class: 'pos-8' },
            { id: 9, class: 'pos-9' },
            { id: 10, class: 'pos-10' }, // Big
            { id: 11, class: 'pos-11' },
            { id: 12, class: 'pos-12' },
            { id: 13, class: 'pos-13' }, // Big
            { id: 14, class: 'pos-14' },
            { id: 15, class: 'pos-15' }
        ];

        let currentBoxId = null;
        const storageKey = 'heart_album_data';

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            renderGrid();
            loadData();
        });

        function renderGrid() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';

            gridStructure.forEach(item => {
                const div = document.createElement('div');
                div.className = `album-box ${item.class}`;
                div.id = `box-${item.id}`;
                div.onclick = () => openModal(item.id);
                
                const img = document.createElement('img');
                img.className = 'album-img';
                img.alt = 'Album Cover';
                
                div.appendChild(img);
                container.appendChild(div);
            });
        }

        // 数据存储与加载
        function loadData() {
            const data = JSON.parse(localStorage.getItem(storageKey) || '{}');
            for (const [id, url] of Object.entries(data)) {
                updateBox(id, url);
            }
        }

        function saveData(id, url) {
            const data = JSON.parse(localStorage.getItem(storageKey) || '{}');
            data[id] = url;
            localStorage.setItem(storageKey, JSON.stringify(data));
        }

        function updateBox(id, url) {
            const box = document.getElementById(`box-${id}`);
            const img = box.querySelector('img');
            
            if (url) {
                img.src = url;
                box.classList.add('has-image');
            } else {
                img.src = '';
                box.classList.remove('has-image');
            }
            box.classList.remove('loading');
        }

        function clearAll() {
            if(confirm('确定要清空所有封面吗？')) {
                localStorage.removeItem(storageKey);
                location.reload();
            }
        }

        // Toast 提示函数
        function showToast(message, type = 'default') {
            const toast = document.getElementById('toast');
            
            // 根据类型设置图标或文字前缀（可选）
            let icon = '';
            if (type === 'success') icon = '✅ ';
            if (type === 'error') icon = '❌ ';
            if (type === 'loading') icon = '⏳ ';

            toast.textContent = icon + message;
            
            // 重置类名
            toast.className = 'toast';
            
            // 强制重绘
            void toast.offsetWidth;
            
            // 添加显示类和类型类
            toast.classList.add('show');
            if (type !== 'loading' && type !== 'default') {
                toast.classList.add(type);
            }
            
            // 3秒后隐藏
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Modal 操作
        const modal = document.getElementById('inputModal');
        const urlInput = document.getElementById('urlInput');
        const errorMsg = document.getElementById('errorMsg');

        function openModal(id) {
            currentBoxId = id;
            urlInput.value = '';
            errorMsg.classList.add('hidden');
            modal.classList.add('active');
            urlInput.focus();
        }

        function closeModal() {
            modal.classList.remove('active');
            currentBoxId = null;
        }

        // 处理 URL 逻辑
        async function confirmUrl() {
            const input = urlInput.value.trim();
            if (!input) {
                closeModal();
                return;
            }

            const box = document.getElementById(`box-${currentBoxId}`);
            box.classList.add('loading');
            closeModal();

            // 显示加载提示
            showToast('正在解析链接...', 'loading');

            try {
                const imageUrl = await processUrl(input);
                if (imageUrl) {
                    updateBox(currentBoxId, imageUrl);
                    saveData(currentBoxId, imageUrl);
                    // 显示成功提示
                    showToast('封面获取成功！', 'success');
                } else {
                    // 显示失败提示
                    showToast('无法提取图片，请检查链接', 'error');
                    box.classList.remove('loading');
                }
            } catch (e) {
                console.error(e);
                // 显示错误提示
                showToast('网络请求失败，请重试', 'error');
                box.classList.remove('loading');
            }
        }

        // 核心逻辑：识别链接并提取图片
        async function processUrl(url) {
            // 1. 如果是直接的图片链接 (以 jpg, png, webp 结尾)
            if (url.match(/\.(jpeg|jpg|gif|png|webp)($|\?)/i)) {
                return url;
            }

            // 2. 网易云音乐链接识别
            // 支持格式: 
            // https://music.163.com/#/album?id=3093066
            // https://music.163.com/album?id=3093066
            // http://163cn.tv/xxxx (短链需要先还原，比较复杂，暂时只支持长链)
            
            const neteaseRegex = /music\.163\.com\/.*[?&]id=(\d+)/;
            const match = url.match(neteaseRegex);

            if (match && match[1]) {
                const albumId = match[1];
                // 尝试通过代理获取页面元数据
                // 我们使用 allorigins.win 作为公共 CORS 代理
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                
                try {
                    const response = await fetch(proxyUrl);
                    const data = await response.json();
                    if (data.contents) {
                        const html = data.contents;
                        // 在HTML中寻找 og:image
                        // 网易云通常有 <meta property="og:image" content="..." />
                        const metaMatch = html.match(/<meta\s+property="og:image"\s+content="([^"]+)"/i);
                        if (metaMatch && metaMatch[1]) {
                            return metaMatch[1];
                        }
                        
                        // 如果 og:image 失败，尝试查找 JSON 数据块
                        const imgRegex = /http:\/\/p\d\.music\.126\.net\/[^"]+\.jpg/;
                        const imgMatch = html.match(imgRegex);
                        if (imgMatch) {
                            return imgMatch[0];
                        }
                    }
                } catch (e) {
                    console.warn("CORS Proxy fetch failed", e);
                }
                
                // 如果抓取失败，返回一个提示让用户手动输入图片地址，或者尝试猜测（网易云没有固定规律的封面URL，很难猜）
                // 这里做一个备选方案：尝试使用 Apple Music 的 iTunes Search API 搜索同名专辑？
                // 为了简单且准确，如果抓取失败，我们只支持图片URL。
                return null;
            }

            // 3. 既不是图片也不是网易云，假设用户粘贴的是其他平台的图片地址
            // 尝试加载一下看看
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(url);
                img.onerror = () => resolve(null);
                img.src = url;
            });
        }
        
        // 支持回车确认
        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') confirmUrl();
        });

    </script>
</body>
</html>